<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markets Fetch Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 {
            color: #4a9eff;
            margin-top: 0;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #3a8eef;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #2d5a2d;
            border: 1px solid #4a9e4a;
        }
        .status.error {
            background: #5a2d2d;
            border: 1px solid #9e4a4a;
        }
        .status.info {
            background: #2d4a5a;
            border: 1px solid #4a7a9e;
        }
        .status.warning {
            background: #5a4a2d;
            border: 1px solid #9e8a4a;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #3a3a3a;
        }
        .market-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #4a9eff;
        }
        .market-item h3 {
            margin: 0 0 10px 0;
            color: #4a9eff;
        }
        .market-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .detail {
            display: flex;
            justify-content: space-between;
        }
        .label {
            color: #aaa;
        }
        .value {
            color: #e0e0e0;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Markets Fetch Test</h1>
        <p>Test if markets are being fetched from the backend API</p>
        
        <div>
            <button id="testBtn" onclick="testMarkets()">Test Markets Fetch</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="config" class="status info" style="margin-top: 20px;">
            <strong>Configuration:</strong><br>
            Backend URL: <span id="backendUrl">http://localhost:8000</span><br>
            API Endpoint: <span id="apiEndpoint">/api/markets</span>
        </div>
    </div>

    <div id="results" class="container" style="display: none;">
        <h2>Test Results</h2>
        <div id="status"></div>
        <div id="markets"></div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8000';
        const API_ENDPOINT = `${BACKEND_URL}/api/markets`;

        document.getElementById('backendUrl').textContent = BACKEND_URL;
        document.getElementById('apiEndpoint').textContent = API_ENDPOINT;

        async function testMarkets() {
            const btn = document.getElementById('testBtn');
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');
            const marketsDiv = document.getElementById('markets');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testing...';
            resultsDiv.style.display = 'block';
            statusDiv.innerHTML = '';
            marketsDiv.innerHTML = '';

            try {
                statusDiv.innerHTML = '<div class="status info">üì° Fetching markets from API...</div>';

                const response = await fetch(`${API_ENDPOINT}?limit=10&offset=0`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const statusInfo = `
                    <div class="status info">
                        <strong>Response Status:</strong> ${response.status} ${response.statusText}<br>
                        <strong>Content-Type:</strong> ${response.headers.get('content-type') || 'Not set'}
                    </div>
                `;
                statusDiv.innerHTML += statusInfo;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    statusDiv.innerHTML += `
                        <div class="status error">
                            <strong>‚ùå ERROR:</strong> Response is not JSON!<br>
                            <strong>Response preview:</strong><br>
                            <pre>${text.substring(0, 500)}</pre>
                            <br>
                            <strong>üí° This usually means:</strong><br>
                            - Backend endpoint doesn't exist<br>
                            - Request is hitting the frontend dev server<br>
                            - Backend is returning HTML instead of JSON
                        </div>
                    `;
                    btn.disabled = false;
                    btn.textContent = 'Test Markets Fetch';
                    return;
                }

                const data = await response.json();
                const markets = Array.isArray(data) ? data : (data.markets || []);

                if (markets.length === 0) {
                    statusDiv.innerHTML += `
                        <div class="status warning">
                            <strong>‚ö†Ô∏è WARNING:</strong> Markets array is empty<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    btn.disabled = false;
                    btn.textContent = 'Test Markets Fetch';
                    return;
                }

                statusDiv.innerHTML += `
                    <div class="status success">
                        <strong>‚úÖ SUCCESS:</strong> Fetched ${markets.length} markets
                    </div>
                `;

                // Validate market structure
                const requiredFields = ['id', 'title', 'category', 'yesPrice', 'noPrice', 'volume'];
                const sampleMarket = markets[0];
                const missingFields = requiredFields.filter(field => !(field in sampleMarket));

                if (missingFields.length > 0) {
                    statusDiv.innerHTML += `
                        <div class="status warning">
                            <strong>‚ö†Ô∏è Missing fields:</strong> ${missingFields.join(', ')}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML += `
                        <div class="status success">
                            <strong>‚úÖ Market structure is valid</strong>
                        </div>
                    `;
                }

                // Display markets
                marketsDiv.innerHTML = '<h3>Markets:</h3>';
                markets.forEach((market, index) => {
                    const marketHtml = `
                        <div class="market-item">
                            <h3>Market #${index + 1}: ${market.title || 'No title'}</h3>
                            <div class="market-details">
                                <div class="detail">
                                    <span class="label">ID:</span>
                                    <span class="value">${market.id || 'N/A'}</span>
                                </div>
                                <div class="detail">
                                    <span class="label">Category:</span>
                                    <span class="value">${market.category || 'N/A'}</span>
                                </div>
                                <div class="detail">
                                    <span class="label">YES Price:</span>
                                    <span class="value">${market.yesPrice || 'N/A'}¬¢</span>
                                </div>
                                <div class="detail">
                                    <span class="label">NO Price:</span>
                                    <span class="value">${market.noPrice || 'N/A'}¬¢</span>
                                </div>
                                <div class="detail">
                                    <span class="label">Volume:</span>
                                    <span class="value">${market.volume || 'N/A'}</span>
                                </div>
                                <div class="detail">
                                    <span class="label">End Date:</span>
                                    <span class="value">${market.endDate || 'N/A'}</span>
                                </div>
                            </div>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #4a9eff;">View Raw JSON</summary>
                                <pre>${JSON.stringify(market, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    marketsDiv.innerHTML += marketHtml;
                });

            } catch (error) {
                statusDiv.innerHTML += `
                    <div class="status error">
                        <strong>‚ùå ERROR:</strong> ${error.message}
                        <br><br>
                        <strong>üí° Troubleshooting:</strong><br>
                        ${error.message.includes('Failed to fetch') || error.message.includes('ECONNREFUSED') 
                            ? '- Backend server is not running<br>- Backend URL is incorrect<br>- Network connection issue<br><br>üîß Try: Start your backend server at ' + BACKEND_URL
                            : error.message.includes('Unexpected token') || error.message.includes('JSON')
                            ? '- Backend returned HTML instead of JSON<br>- API endpoint doesn\'t exist'
                            : '- Check browser console for more details'}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Markets Fetch';
            }
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('status').innerHTML = '';
            document.getElementById('markets').innerHTML = '';
        }
    </script>
</body>
</html>

